<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lovable Referral Tester - Dashboard</title>
  <link rel="stylesheet" href="{{BASE_PATH}}/styles.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <h1>üöÄ Lovable Referral Tester</h1>
        <div class="header-status">
          <span class="status-indicator" id="connectionStatus">
            <span class="status-dot status-connecting"></span>
            Conectando...
          </span>
        </div>
      </div>
    </header>

    <!-- Stats Overview -->
    <section class="stats-overview">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
          <div class="stat-label">Total de Filas</div>
          <div class="stat-value" id="totalQueues">0</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">‚ñ∂Ô∏è</div>
        <div class="stat-content">
          <div class="stat-label">Filas Ativas</div>
          <div class="stat-value" id="runningQueues">0</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
          <div class="stat-label">Sucessos</div>
          <div class="stat-value" id="totalSuccess">0</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <div class="stat-label">Cr√©ditos Gerados</div>
          <div class="stat-value" id="totalCredits">0</div>
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Left Panel - Queues -->
      <section class="panel panel-queues">
        <div class="panel-header">
          <h2>üìã Filas de Execu√ß√£o</h2>
          <button class="btn btn-primary" onclick="app.showCreateQueueModal()">
            + Nova Fila
          </button>
        </div>
        
        <div class="queues-list" id="queuesList">
          <div class="empty-state">
            <p>Nenhuma fila criada ainda</p>
            <button class="btn btn-secondary" onclick="app.showCreateQueueModal()">
              Criar primeira fila
            </button>
          </div>
        </div>
      </section>

      <!-- History Panel -->
      <section class="panel panel-history">
        <div class="panel-header">
          <h2>üìö Hist√≥rico de Execu√ß√µes</h2>
          <button class="btn btn-small btn-secondary" onclick="app.clearHistory()">
            Limpar
          </button>
        </div>
        <div class="history-list" id="historyList">
          <div class="loading">Carregando hist√≥rico...</div>
        </div>
      </section>

      <!-- Metrics Panel -->
      <section class="panel panel-metrics">
        <div class="panel-header">
          <h2>üìä M√©tricas (Sucessos e Erros)</h2>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-small btn-secondary" onclick="app.fetchMetrics()">
              üîÑ Atualizar
            </button>
            <button class="btn btn-small btn-danger" onclick="app.clearMetrics()" title="Limpar todas as m√©tricas">
              üóëÔ∏è Limpar
            </button>
          </div>
        </div>
        <div class="metrics-content" id="metricsContent">
          <div class="loading">Carregando m√©tricas...</div>
        </div>
      </section>

      <!-- Recent Failures Panel -->
      <section class="panel panel-failures">
        <div class="panel-header">
          <h2>‚ùå Falhas Recentes</h2>
          <button class="btn btn-small btn-secondary" onclick="app.fetchFailures()">
            üîÑ Atualizar
          </button>
        </div>
        <div class="failures-list" id="failuresList">
          <div class="loading">Carregando falhas...</div>
        </div>
      </section>

      <!-- Right Panel - Domains & Executions -->
      <aside class="sidebar">
        <!-- Logs Panel Toggle -->
        <section class="panel panel-logs-toggle">
          <button class="btn btn-secondary w-full" onclick="app.toggleLogs()">
            üìú Mostrar/Ocultar Logs
          </button>
        </section>

        <!-- Active Executions -->
        <section class="panel panel-executions">
          <div class="panel-header">
            <h3>‚ö° Execu√ß√µes Ativas</h3>
            <span class="badge" id="activeExecutionsCount">0</span>
          </div>
          
          <div class="executions-list" id="executionsList">
            <div class="empty-state-small">
              Nenhuma execu√ß√£o ativa
            </div>
          </div>
        </section>

        <!-- Domains -->
        <section class="panel panel-domains">
          <div class="panel-header">
            <h3>üìß Dom√≠nios de Email</h3>
            <button class="btn btn-small" onclick="app.showDomainsModal()">
              ‚öôÔ∏è
            </button>
          </div>
          
          <div class="domains-list" id="domainsList">
            <div class="loading">Carregando...</div>
          </div>
          
          <div class="domain-info">
            <p class="info-text">
              <strong>Atual:</strong> <span id="currentDomain">-</span>
            </p>
            <p class="info-text">
              <strong>Total:</strong> <span id="totalDomains">0</span>
            </p>
          </div>
        </section>
      </aside>
    </div>

    <!-- Logs Panel (Hidden by default) -->
    <div id="logsPanel" class="logs-panel hidden">
      <div class="logs-header">
        <h3>üìú Logs do Sistema</h3>
        <div class="logs-actions">
          <button class="btn btn-small" onclick="app.clearLogs()">Limpar</button>
          <button class="btn btn-small" onclick="app.toggleLogs()">Fechar</button>
        </div>
      </div>
      <div class="logs-content" id="systemLogs">
        <!-- Logs ser√£o inseridos aqui -->
      </div>
    </div>
  </div>

  <!-- Error Alert Container -->
  <div id="alertContainer" class="alert-container"></div>

  <!-- Modal: Create Queue -->
  <div class="modal" id="createQueueModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üöÄ Nova Fila de Execu√ß√£o</h2>
        <button class="modal-close" onclick="app.hideCreateQueueModal()">√ó</button>
      </div>
      
      <form onsubmit="app.createQueue(event)">
        <div class="form-group">
          <label for="queueReferralLink">üîó Link de Indica√ß√£o</label>
          <input 
            type="url" 
            id="queueReferralLink" 
            placeholder="https://lovable.dev/invite/XXXXXXX"
            required
          >
          <small>O link de indica√ß√£o da Lovable (obrigat√≥rio)</small>
        </div>

        <div class="form-group">
          <label for="queueName">Nome da Fila</label>
          <input 
            type="text" 
            id="queueName" 
            placeholder="Ex: Teste 10 indica√ß√µes"
            required
          >
        </div>
        
        <div class="form-group">
          <label for="queueUsers">N√∫mero de Usu√°rios (Indica√ß√µes)</label>
          <input 
            type="number" 
            id="queueUsers" 
            min="1" 
            max="1000" 
            value="3"
            required
          >
          <small>Cada usu√°rio gera 10 cr√©ditos</small>
        </div>
        
        <div class="form-group">
          <label for="queueParallel">Execu√ß√µes Paralelas</label>
          <input 
            type="number" 
            id="queueParallel" 
            min="1" 
            max="5" 
            value="1"
            required
          >
          <small>M√°ximo: 5 sess√µes simult√¢neas (cada uma com fingerprint √∫nico)</small>
        </div>

        <div class="form-group">
          <label>Dom√≠nios para esta Fila</label>
          <small style="margin-bottom: 8px;">Selecione quais dom√≠nios usar. Se nenhum for marcado, usa rota√ß√£o global.</small>
          <div style="margin-bottom: 8px; display: flex; gap: 8px;">
            <button type="button" class="btn btn-small btn-secondary" onclick="app.selectAllDomains()">
              ‚úì Todos
            </button>
            <button type="button" class="btn btn-small btn-secondary" onclick="app.clearDomainSelection()">
              ‚úó Nenhum
            </button>
          </div>
          <div id="queueDomainSelection" class="domain-selection-list">
            <!-- Checkboxes ser√£o inseridos via JS -->
          </div>
        </div>

        <div class="form-group">
          <label>Proxies para esta Fila (Opcional)</label>
          <small style="margin-bottom: 8px; display: block; color: var(--warning); font-weight: 500;">
            ‚ö†Ô∏è Recomendado usar proxies apenas em muitas opera√ß√µes paralelas e preferencialmente no modo Random.
            Para poucas execu√ß√µes paralelas, usar IP local √© mais r√°pido e eficiente.
          </small>
          <small style="margin-bottom: 8px; display: block;">Selecione quais proxies usar. Se nenhum for marcado, usa IP local ou proxy global.</small>
          <div style="margin-bottom: 8px; display: flex; gap: 8px;">
            <button type="button" class="btn btn-small btn-secondary" onclick="app.selectAllProxies()">
              ‚úì Todos
            </button>
            <button type="button" class="btn btn-small btn-secondary" onclick="app.clearProxySelection()">
              ‚úó Nenhum
            </button>
          </div>
          <div id="queueProxySelection" class="domain-selection-list">
            <!-- Checkboxes ser√£o inseridos via JS -->
          </div>
        </div>

        <div class="form-group" style="border-top: 2px solid var(--border); padding-top: 16px; margin-top: 16px;">
          <label>üß™ Simular Erros (Para Testar Fallbacks)</label>
          <small style="margin-bottom: 8px; display: block; color: var(--text-secondary);">
            Selecione quais erros simular para testar os fallbacks do sistema. √ötil para validar a resili√™ncia.
          </small>
          <div id="queueErrorSimulation" class="domain-selection-list">
            <div class="error-checkbox">
              <input type="checkbox" id="simulate-template-error" value="template_error">
              <label for="simulate-template-error">
                ‚ùå Erro de Template (testa fallback para template espec√≠fico)
              </label>
            </div>
            <div class="error-checkbox">
              <input type="checkbox" id="simulate-publish-error" value="publish_error">
              <label for="simulate-publish-error">
                ‚ùå Erro de Publish (testa retry com refresh)
              </label>
            </div>
            <div class="error-checkbox">
              <input type="checkbox" id="simulate-email-error" value="email_error">
              <label for="simulate-email-error">
                ‚ùå Erro de Email (testa detec√ß√£o de dom√≠nio cansado)
              </label>
            </div>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="app.hideCreateQueueModal()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            Criar Fila
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Manage Domains -->
  <div class="modal" id="domainsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìß Gerenciar Dom√≠nios de Email</h2>
        <button class="modal-close" onclick="app.hideDomainsModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <p class="info-text">
          Os dom√≠nios ser√£o alternados de forma global. Se voc√™ tiver 2 dom√≠nios, 
          o primeiro usu√°rio usar√° dom√≠nio1, o segundo dom√≠nio2, o terceiro dom√≠nio1, etc.
        </p>
        
        <div class="form-group">
          <label>Dom√≠nios Atuais</label>
          <div id="domainsEditor"></div>
        </div>
        
        <div class="form-group">
          <label for="newDomain">Adicionar Novo Dom√≠nio</label>
          <div class="input-group">
            <input 
              type="text" 
              id="newDomain" 
              placeholder="exemplo.com"
            >
            <button type="button" class="btn btn-primary" onclick="app.addDomain()">
              Adicionar
            </button>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="app.resetDomainIndex()">
            üîÑ Resetar Altern√¢ncia
          </button>
          <button type="button" class="btn btn-primary" onclick="app.hideDomainsModal()">
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <p>Lovable Referral Tester - Vers√£o <strong>1.1</strong></p>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    // Define BASE_PATH
    window.BASE_PATH = '{{BASE_PATH}}' || '';
  </script>
  <script src="{{BASE_PATH}}/socket.io/socket.io.js"></script>
  <script src="{{BASE_PATH}}/app.js"></script>
</body>
</html>

