<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lovable Referral Tester - Dashboard</title>
  <link rel="stylesheet" href="{{BASE_PATH}}/styles.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <h1>üöÄ Lovable Referral Tester</h1>
        <div class="header-status">
          <span class="status-indicator" id="connectionStatus">
            <span class="status-dot status-connecting"></span>
            Conectando...
          </span>
        </div>
      </div>
    </header>

    <!-- Stats Overview -->
    <section class="stats-overview">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
          <div class="stat-label">Total de Filas</div>
          <div class="stat-value" id="totalQueues">0</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">‚ñ∂Ô∏è</div>
        <div class="stat-content">
          <div class="stat-label">Filas Ativas</div>
          <div class="stat-value" id="runningQueues">0</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
          <div class="stat-label">Sucessos</div>
          <div class="stat-value" id="totalSuccess">0</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <div class="stat-label">Cr√©ditos Gerados</div>
          <div class="stat-value" id="totalCredits">0</div>
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Left Panel - Queues -->
      <section class="panel panel-queues">
        <div class="panel-header">
          <h2>üìã Filas de Execu√ß√£o</h2>
          <button class="btn btn-primary" onclick="app.showCreateQueueModal()">
            + Nova Fila
          </button>
        </div>
        
        <div class="queues-list" id="queuesList">
          <div class="empty-state">
            <p>Nenhuma fila criada ainda</p>
            <button class="btn btn-secondary" onclick="app.showCreateQueueModal()">
              Criar primeira fila
            </button>
          </div>
        </div>
      </section>

      <!-- History Panel -->
      <section class="panel panel-history">
        <div class="panel-header">
          <h2>üìö Hist√≥rico de Execu√ß√µes</h2>
          <button class="btn btn-small btn-secondary" onclick="app.clearHistory()">
            Limpar
          </button>
        </div>
        <div class="history-list" id="historyList">
          <div class="loading">Carregando hist√≥rico...</div>
        </div>
      </section>

      <!-- Metrics Panel -->
      <section class="panel panel-metrics">
        <div class="panel-header">
          <h2>üìä M√©tricas (Sucessos e Erros)</h2>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-small btn-danger" onclick="app.clearMetrics()" title="Limpar todas as m√©tricas">
              üóëÔ∏è Limpar
            </button>
          </div>
        </div>
        <div class="metrics-content" id="metricsContent">
          <div class="loading">Carregando m√©tricas...</div>
        </div>
      </section>

      <!-- Recent Failures Panel -->
      <section class="panel panel-failures">
        <div class="panel-header">
          <h2>‚ùå Falhas Recentes</h2>
        </div>
        <div class="failures-list" id="failuresList">
          <div class="loading">Carregando falhas...</div>
        </div>
      </section>

      <!-- Right Panel - Domains & Executions -->
      <aside class="sidebar">
        <!-- Logs Panel Toggle -->
        <section class="panel panel-logs-toggle">
          <button class="btn btn-secondary w-full" onclick="app.toggleLogs()">
            üìú Mostrar/Ocultar Logs
          </button>
        </section>

        <!-- Active Executions -->
        <section class="panel panel-executions">
          <div class="panel-header">
            <h3>‚ö° Execu√ß√µes Ativas</h3>
            <span class="badge" id="activeExecutionsCount">0</span>
          </div>
          
          <div class="executions-list" id="executionsList">
            <div class="empty-state-small">
              Nenhuma execu√ß√£o ativa
            </div>
          </div>
        </section>

        <!-- Domains -->
        <section class="panel panel-domains">
          <div class="panel-header">
            <h3>üìß Dom√≠nios de Email</h3>
            <button class="btn btn-small" onclick="app.showDomainsModal()">
              ‚öôÔ∏è
            </button>
          </div>
          
          <div class="domains-list" id="domainsList">
            <div class="loading">Carregando...</div>
          </div>
          
          <div class="domain-info">
            <p class="info-text">
              <strong>Atual:</strong> <span id="currentDomain">-</span>
            </p>
            <p class="info-text">
              <strong>Total:</strong> <span id="totalDomains">0</span>
            </p>
          </div>
        </section>
      </aside>
    </div>

    <!-- Logs Panel (Hidden by default) -->
    <div id="logsPanel" class="logs-panel hidden">
      <div class="logs-header">
        <h3>üìú Logs do Sistema</h3>
        <div class="logs-actions">
          <button class="btn btn-small" onclick="app.clearLogs()">Limpar</button>
          <button class="btn btn-small" onclick="app.toggleLogs()">Fechar</button>
        </div>
      </div>
      <div class="logs-content" id="systemLogs" onscroll="app.checkLogsScrollPosition()">
        <!-- Logs ser√£o inseridos aqui -->
      </div>
      <button id="scrollLogsDownBtn" class="scroll-down-btn" onclick="app.scrollLogsToBottom()" title="Ir para o final">
        ‚Üì
      </button>
    </div>
  </div>

  <!-- Modal: Create Queue -->
  <div class="modal" id="createQueueModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>üöÄ Nova Fila de Execu√ß√£o</h2>
        <button class="modal-close" onclick="app.hideCreateQueueModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <form onsubmit="app.createQueue(event)" class="modal-form">
          <!-- Se√ß√£o Principal -->
          <div class="form-section">
          <div class="form-group">
            <label for="queueReferralLink">üîó Link de Indica√ß√£o</label>
            <input 
              type="url" 
              id="queueReferralLink" 
              placeholder="https://lovable.dev/invite/XXXXXXX"
              required
            >
            <small>O link de indica√ß√£o da Lovable (obrigat√≥rio)</small>
          </div>

          <div class="form-group">
            <label for="queueName">üìù Nome da Fila</label>
            <input 
              type="text" 
              id="queueName" 
              placeholder="Ex: Teste 10 indica√ß√µes"
              required
            >
          </div>
          
          <div class="form-row">
            <div class="form-group form-group-half">
              <label for="queueUsers">üë• N√∫mero de Usu√°rios</label>
              <input 
                type="number" 
                id="queueUsers" 
                min="1" 
                max="10000" 
                value="10"
                oninput="app.updateCreditsPreview(this.value)"
                required
              >
              <small>Indica√ß√µes a criar</small>
            </div>
            
            <div class="form-group form-group-half">
              <label for="queueParallel">‚ö° Execu√ß√µes Paralelas</label>
              <input 
                type="number" 
                id="queueParallel" 
                min="1" 
                max="10" 
                value="3"
                required
              >
              <small>M√°ximo: 10 simult√¢neas</small>
            </div>
          </div>
          
          <div class="credits-preview-box">
            <div class="credits-preview-icon">üí∞</div>
            <div class="credits-preview-content">
              <div class="credits-preview-label">Cr√©ditos que ser√£o gerados</div>
              <div class="credits-preview-value" id="creditsPreview">100 cr√©ditos</div>
              <div class="credits-preview-concurrent" id="creditsPreviewConcurrent" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(86, 171, 47, 0.3);">
                <div style="font-size: 11px; color: #56ab2f; margin-bottom: 4px;">Com requisi√ß√µes ativadas:</div>
                <div style="font-size: 13px; color: #a8e063; font-weight: 600;" id="creditsPreviewConcurrentRange">de 600 a 750 cr√©ditos</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Se√ß√£o: Op√ß√µes Avan√ßadas -->
        <div class="form-section form-section-divider">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 class="form-section-title" style="margin: 0;">‚öôÔ∏è Op√ß√µes Avan√ßadas</h3>
            <button type="button" class="btn btn-tiny btn-secondary" onclick="app.enableAllOptions()" style="padding: 6px 12px; font-size: 11px;">
              ‚úì Ativar Todas
            </button>
          </div>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="queueForceCredits" class="checkbox-input" checked>
              <span class="checkbox-custom"></span>
              <div class="checkbox-content">
                <div class="checkbox-title">üí∞ Meta de Cr√©ditos</div>
                <div class="checkbox-description">
                  O sistema continuar√° tentando at√© atingir a meta, criando novas tentativas automaticamente mesmo em caso de erros.
                </div>
              </div>
            </label>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="queueTurboMode" class="checkbox-input" checked onchange="app.onTurboModeChange()">
              <span class="checkbox-custom"></span>
              <div class="checkbox-content">
                <div class="checkbox-title">‚ö° Modo Turbo</div>
                <div class="checkbox-description">
                  Ap√≥s verificar o email, pula o quiz e a sele√ß√£o de template, indo direto para o template fallback. Acelera significativamente a execu√ß√£o.
                </div>
              </div>
            </label>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="queueCheckCreditsBanner" class="checkbox-input" checked>
              <span class="checkbox-custom"></span>
              <div class="checkbox-content">
                <div class="checkbox-title">üîç Verificar Banner de Cr√©ditos (Modo Turbo)</div>
                <div class="checkbox-description">
                  Procura o banner superior de 10 cr√©ditos no editor antes de publicar. Dispon√≠vel apenas quando Modo Turbo est√° ativo. Se n√£o encontrar, gera erro na etapa final.
                </div>
              </div>
            </label>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="queueEnableConcurrentRequests" class="checkbox-input" checked onchange="app.onConcurrentRequestsChange()">
              <span class="checkbox-custom"></span>
              <div class="checkbox-content">
                <div class="checkbox-title">‚ö° Teste de Requisi√ß√µes Simult√¢neas</div>
                <div class="checkbox-description">
                  Intercepta a requisi√ß√£o de publica√ß√£o e faz m√∫ltiplas requisi√ß√µes simult√¢neas para testar bugs. Segue a mesma l√≥gica da extens√£o Chrome.
                </div>
              </div>
            </label>
          </div>

          <div class="form-group" id="concurrentRequestsGroup" style="display: block; margin-left: 32px; margin-top: 12px; padding: 12px; background: rgba(86, 171, 47, 0.1); border: 1px solid rgba(86, 171, 47, 0.3); border-radius: 8px;">
            <label for="queueConcurrentRequests" style="display: block; font-weight: 600; margin-bottom: 8px; color: #a8e063;">
              üìä N√∫mero de Requisi√ß√µes Simult√¢neas
            </label>
            <input 
              type="number" 
              id="queueConcurrentRequests" 
              min="1" 
              max="1000" 
              value="100"
              required
              style="width: 100%; padding: 10px; border: 2px solid #56ab2f; border-radius: 6px; font-size: 16px; font-weight: bold; text-align: center; background: #0d0d0d; color: #a8e063;"
            >
            <small style="display: block; margin-top: 8px; color: #56ab2f; font-size: 12px;">
              üí° N√∫mero de requisi√ß√µes simult√¢neas a fazer (padr√£o: 100 = 1000 cr√©ditos estimados)
              <br>
              ‚ö†Ô∏è A primeira requisi√ß√£o √© a original, ent√£o ser√£o feitas (N-1) requisi√ß√µes adicionais
              <br>
              üìä M√°ximo: 1000 requisi√ß√µes (999 adicionais + 1 original)
            </small>
          </div>
        </div>

        <!-- Se√ß√£o: Configura√ß√µes de Email e Proxy -->
        <div class="form-section form-section-divider">
          <h3 class="form-section-title">üìß Configura√ß√µes de Email</h3>
          
          <div class="form-group">
            <div class="form-group-header">
              <label>Dom√≠nios para esta Fila</label>
              <div class="form-group-actions">
                <button type="button" class="btn btn-tiny btn-secondary" onclick="app.selectAllDomains()">
                  ‚úì Todos
                </button>
                <button type="button" class="btn btn-tiny btn-secondary" onclick="app.clearDomainSelection()">
                  ‚úó Nenhum
                </button>
              </div>
            </div>
            <small>Selecione quais dom√≠nios usar. Se nenhum for marcado, usa rota√ß√£o global.</small>
            <div id="queueDomainSelection" class="domain-selection-list">
              <!-- Checkboxes ser√£o inseridos via JS -->
            </div>
          </div>

          <div class="form-group">
            <div class="form-group-header">
              <label>üåê Proxies para esta Fila <span class="optional-badge">Opcional</span></label>
              <div class="form-group-actions">
                <button type="button" class="btn btn-tiny btn-secondary" onclick="app.selectAllProxies()">
                  ‚úì Todos
                </button>
                <button type="button" class="btn btn-tiny btn-secondary" onclick="app.clearProxySelection()">
                  ‚úó Nenhum
                </button>
              </div>
            </div>
            <small class="warning-text">
              ‚ö†Ô∏è Recomendado usar proxies apenas em muitas opera√ß√µes paralelas. Para poucas execu√ß√µes, usar IP local √© mais r√°pido.
            </small>
            <div id="queueProxySelection" class="domain-selection-list">
              <!-- Checkboxes ser√£o inseridos via JS -->
            </div>
          </div>
        </div>

        <!-- Se√ß√£o: Testes -->
        <div class="form-section form-section-divider">
          <h3 class="form-section-title">üß™ Simular Erros (Para Testar)</h3>
          <small class="form-section-description">Selecione quais erros simular para testar os fallbacks do sistema.</small>
          
          <div id="queueErrorSimulation" class="error-simulation-list">
            <div class="error-checkbox">
              <input type="checkbox" id="simulate-template-error" value="template_error">
              <label for="simulate-template-error">
                <span class="error-checkbox-icon">‚ùå</span>
                <div class="error-checkbox-content">
                  <div class="error-checkbox-title">Erro de Template</div>
                  <div class="error-checkbox-desc">Testa fallback para template espec√≠fico</div>
                </div>
              </label>
            </div>
            <div class="error-checkbox">
              <input type="checkbox" id="simulate-publish-error" value="publish_error">
              <label for="simulate-publish-error">
                <span class="error-checkbox-icon">‚ùå</span>
                <div class="error-checkbox-content">
                  <div class="error-checkbox-title">Erro de Publish</div>
                  <div class="error-checkbox-desc">Testa retry com refresh</div>
                </div>
              </label>
            </div>
            <div class="error-checkbox">
              <input type="checkbox" id="simulate-email-error" value="email_error">
              <label for="simulate-email-error">
                <span class="error-checkbox-icon">‚ùå</span>
                <div class="error-checkbox-content">
                  <div class="error-checkbox-title">Erro de Email</div>
                  <div class="error-checkbox-desc">Testa detec√ß√£o de dom√≠nio cansado</div>
                </div>
              </label>
            </div>
          </div>
        </div>
        
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="app.hideCreateQueueModal()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary btn-large">
              ‚úÖ Criar Fila
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Manage Domains -->
  <div class="modal" id="domainsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìß Gerenciar Dom√≠nios de Email</h2>
        <button class="modal-close" onclick="app.hideDomainsModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <p class="info-text">
          Os dom√≠nios ser√£o alternados de forma global. Se voc√™ tiver 2 dom√≠nios, 
          o primeiro usu√°rio usar√° dom√≠nio1, o segundo dom√≠nio2, o terceiro dom√≠nio1, etc.
        </p>
        
        <div class="form-group">
          <label>Dom√≠nios Atuais</label>
          <div id="domainsEditor"></div>
        </div>
        
        <div class="form-group">
          <label for="newDomain">Adicionar Novo Dom√≠nio</label>
          <div class="input-group">
            <input 
              type="text" 
              id="newDomain" 
              placeholder="exemplo.com"
            >
            <button type="button" class="btn btn-primary" onclick="app.addDomain()">
              Adicionar
            </button>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="app.resetDomainIndex()">
            üîÑ Resetar Altern√¢ncia
          </button>
          <button type="button" class="btn btn-primary" onclick="app.hideDomainsModal()">
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <p>Lovable Referral Tester - Vers√£o <strong>2.0</strong></p>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    // Define BASE_PATH
    window.BASE_PATH = '{{BASE_PATH}}' || '';
  </script>
  <script src="{{BASE_PATH}}/socket.io/socket.io.js"></script>
  <script src="{{BASE_PATH}}/app.js"></script>
</body>
</html>

